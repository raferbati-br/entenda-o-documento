# C3 - Componentes

## Componentes do servidor (API Routes)
- /api/session-token: emite token de sessão de curta duração
- /api/capture: valida e armazena imagem (TTL curto)
- /api/ocr: carrega imagem e extrai texto (OCR via LLM)
- /api/analyze: carrega imagem e executa pipeline de IA
- /api/qa: responde perguntas com base no contexto extraído
- /api/feedback: registra feedback agregado
- /api/health: health check simples
- /metrics: dashboard interno de contadores de qualidade

## Componentes do pipeline de IA
- Registro de prompts (src/ai/prompts)
- Adaptador de provedores (src/ai/providers)
- Postprocess e suavização de linguagem (src/ai/postprocess.ts)
- Extração OCR (src/ai/extractDocumentText.ts)
- Respostas de Q&A (src/ai/answerQuestion.ts)
- Agregação de métricas de qualidade (src/lib/qualityMetrics.ts)

## Componentes transversais
- Rate limiting (src/lib/rateLimit.ts)
- Auth de token de sessão + verificação de origem (src/lib/requestAuth.ts)
- Armazenamento no cliente (src/lib/captureStore.ts, src/lib/resultStore.ts, src/lib/captureIdStore.ts)
- Telemetria (src/lib/telemetry.ts, src/app/providers.tsx)

## Diagrama
```mermaid
flowchart LR
  %% API Routes
  subgraph API[API Routes]
    Capture[/api/capture/]
    Ocr[/api/ocr/]
    Analyze[/api/analyze/]
    Qa[/api/qa/]
    Feedback[/api/feedback/]
  end

  %% Stores
  subgraph Stores[Stores]
    CaptureStore[(Capture Store)]
    FeedbackStore[(Feedback Counters)]
    MetricsStore[(Quality Counters)]
  end

  %% AI Pipeline
  subgraph AI[Pipeline de IA]
    OcrFlow[extractDocumentText]
    OcrPrompt[getOcrPrompt]
    AnalyzeDoc[analyzeDocument]
    MainPrompt[getPrompt]
    QaFlow[answerQuestion]
    QaPrompt[getQaPrompt]
    Postprocess[postprocess]
    Metrics[qualityMetrics]
    Provider[getProvider: OpenAI/Gemini/Mock]
  end

  %% Dashboard
  MetricsDash[/metrics/]

  Capture --> CaptureStore
  Ocr --> CaptureStore
  Analyze --> CaptureStore
  Feedback --> FeedbackStore

  Ocr --> OcrFlow --> OcrPrompt --> Provider
  Analyze --> AnalyzeDoc --> MainPrompt --> Provider
  AnalyzeDoc --> Postprocess
  AnalyzeDoc --> Metrics --> MetricsStore --> MetricsDash

  Qa --> QaFlow --> QaPrompt --> Provider

  %% Cores
  classDef api fill:#e8f1ff,stroke:#3b82f6,stroke-width:1px,color:#111827;
  classDef store fill:#ecfdf3,stroke:#10b981,stroke-width:1px,color:#065f46;
  classDef ai fill:#fff7ed,stroke:#f97316,stroke-width:1px,color:#9a3412;
  classDef dash fill:#f5f3ff,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95;

  class Capture,Ocr,Analyze,Qa,Feedback api;
  class CaptureStore,FeedbackStore,MetricsStore store;
  class OcrFlow,OcrPrompt,AnalyzeDoc,MainPrompt,QaFlow,QaPrompt,Postprocess,Metrics,Provider ai;
  class MetricsDash dash;
```
