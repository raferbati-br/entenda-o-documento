# C4 - Code (Key Flows)

## Flow: Capture -> Analyze -> Result
1) App requests a short-lived token from /api/session-token.
2) User selects a photo and confirms.
3) /api/capture validates base64, checks origin/token, and stores in Redis with a TTL (memory fallback in dev).
4) /api/ocr checks origin/token, fetches image from Redis, and extracts documentText for Q&A.
5) /api/analyze checks origin/token, fetches image from Redis, and calls analyzeDocument.
6) analyzeDocument calls provider (OpenAI) and postprocess.
7) Result is saved in sessionStorage and rendered in /result.
8) Optional: /api/qa answers user questions based on OCR context (fallback to cards).
9) Optional: /api/feedback records thumbs up/down with reason (aggregated).

## Key Files
- src/app/api/capture/route.ts
- src/app/api/ocr/route.ts
- src/app/api/analyze/route.ts
- src/app/api/qa/route.ts
- src/app/api/feedback/route.ts
- src/app/api/session-token/route.ts
- src/ai/analyzeDocument.ts
- src/ai/extractDocumentText.ts
- src/ai/answerQuestion.ts
- src/ai/providers/openaiProvider.ts
- src/ai/postprocess.ts
- src/lib/captureStoreServer.ts
- src/lib/captureStore.ts
- src/lib/qaContextStore.ts
- src/lib/resultStore.ts
- src/lib/requestAuth.ts
- src/lib/sessionToken.ts
